{
  "version": 3,
  "sources": [],
  "sections": [
    {"offset": {"line": 46, "column": 0}, "map": {"version":3,"sources":["file:///home/runner/workspace/app/api/search/route.ts"],"sourcesContent":["import { NextRequest, NextResponse } from 'next/server';\n\nconst WP_API_BASE = \"https://dir.lascrucesdirectory.com/wp-json/geodir/v2\";\n\ninterface SearchResult {\n  id: number;\n  slug: string;\n  title: string;\n  type: string;\n  typeLabel: string;\n  city?: string;\n  category?: string;\n  image?: string;\n}\n\nexport async function GET(request: NextRequest) {\n  const searchParams = request.nextUrl.searchParams;\n  const query = searchParams.get('q');\n  const limit = parseInt(searchParams.get('limit') || '10');\n\n  if (!query || query.length < 2) {\n    return NextResponse.json({ results: [] });\n  }\n\n  try {\n    const endpoints = [\n      { type: 'restaurant', label: 'Restaurant', url: `${WP_API_BASE}/restaurant?search=${encodeURIComponent(query)}&per_page=${limit}` },\n      { type: 'business', label: 'Business', url: `${WP_API_BASE}/business?search=${encodeURIComponent(query)}&per_page=${limit}` },\n      { type: 'accommodation', label: 'Accommodation', url: `${WP_API_BASE}/accommodation?search=${encodeURIComponent(query)}&per_page=${limit}` },\n      { type: 'places', label: 'Place', url: `${WP_API_BASE}/places?search=${encodeURIComponent(query)}&per_page=${limit}` },\n    ];\n\n    const responses = await Promise.all(\n      endpoints.map(async ({ type, label, url }) => {\n        try {\n          const res = await fetch(url, { next: { revalidate: 300 } });\n          if (!res.ok) return [];\n          const data = await res.json();\n          return data.map((item: any) => ({\n            id: item.id,\n            slug: item.slug,\n            title: decodeHtmlEntities(item.title?.rendered || item.title || ''),\n            type,\n            typeLabel: label,\n            city: item.city || item.location?.city,\n            category: item.post_category?.[0]?.name?.replace(/&amp;/g, '&'),\n            image: getListingImage(item),\n          }));\n        } catch {\n          return [];\n        }\n      })\n    );\n\n    const allResults: SearchResult[] = [];\n    const perTypeLimit = Math.ceil(limit / 4);\n    \n    responses.forEach((typeResults) => {\n      allResults.push(...typeResults.slice(0, perTypeLimit));\n    });\n    \n    const sortedResults = allResults.slice(0, limit);\n\n    return NextResponse.json({ results: sortedResults });\n  } catch (error) {\n    console.error('Search error:', error);\n    return NextResponse.json({ results: [], error: 'Search failed' }, { status: 500 });\n  }\n}\n\nfunction decodeHtmlEntities(text: string): string {\n  const entities: Record<string, string> = {\n    \"&amp;\": \"&\",\n    \"&lt;\": \"<\",\n    \"&gt;\": \">\",\n    \"&quot;\": '\"',\n    \"&#039;\": \"'\",\n    \"&#8217;\": \"'\",\n    \"&#8216;\": \"'\",\n    \"&#8220;\": '\"',\n    \"&#8221;\": '\"',\n    \"&#038;\": \"&\",\n  };\n  return text.replace(/&[#a-z0-9]+;/gi, (match) => entities[match] || match);\n}\n\nfunction getListingImage(listing: any): string | undefined {\n  if (listing.featured_image?.src) {\n    return `/api/image-proxy?url=${encodeURIComponent(listing.featured_image.src)}`;\n  }\n  if (listing.images?.[0]?.src) {\n    return `/api/image-proxy?url=${encodeURIComponent(listing.images[0].src)}`;\n  }\n  return undefined;\n}\n"],"names":[],"mappings":"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"}}]
}